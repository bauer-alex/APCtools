---
title: "Functionality of APCtools package"
author: "Alexander Bauer, Maximilian Weigert, Pauline Hohenemser"
date: "`r format(Sys.time(), '%d.%B %Y')`"
output:
  html_document:
    toc: yes
  vignette: >
    %\VignetteIndexEntry{Functionality of TouristClust package}
    %\usepackage[utf8]{inputenc}
    %\VignetteEngine{knitr::rmarkdown}
  rmarkdown::html_vignette: default
editor_options:
  chunk_output_type: console
---

This document gives an overview of the functionality provided by the R package
`APCtools`.

```{r packages, message = FALSE}
library(APCtools)
library(dplyr)
library(mgcv)

# set the global theme of all plots
library(ggplot2)
theme_set(theme_minimal())
```

### Data overview

```{r data preparation}
data(travel)
# alternative: drug deaths data
data(drug_deaths)

options(knitr.kable.NA = '')
summary(travel) %>% 
  knitr::kable()
```

# Descriptive analyses

### 1D visualization function for metric and categorical variables

```{r}
# plot a metric variable
plot_variable(dat = travel, variable = "mainTrip_distance", apc_dimension = "period", log_scale = TRUE)

# plot a categorical variable
plot_variable(dat = travel, variable = "household_size", apc_dimension = "period")
plot_variable(dat = travel, variable = "household_size", apc_dimension = "period", geomBar_position = "stack")
```

### Density matrix for metric and categorical variables

```{r density matrix}
dist_cat_breaks <- c(1,500,1000,2000,6000,100000)
dist_cat_labels <- c("< 500 km","500 - 1,000 km", "1,000 - 2,000 km", "2,000 - 6,000 km", "> 6,000 km")

age_groups    <- list(c(80,89),c(70,79),c(60,69),c(50,59),c(40,49),c(30,39),c(20,29))
period_groups <- list(c(1971,1979),c(1980,1989),c(1990,1999),c(2000,2009),c(2010,2018))
cohort_groups <- list(c(1980,1989),c(1970,1979),c(1960,1969),c(1950,1959),c(1940,1949),c(1930,1939),c(1920,1929))

plot_densityMatrix(dat              = travel,
                   y_var            = "mainTrip_distance",
                   age_groups       = age_groups,
                   period_groups    = period_groups,
                   log_scale        = TRUE)

plot_densityMatrix(dat                 = travel,
                   y_var               = "mainTrip_distance",
                   age_groups          = age_groups,
                   period_groups       = period_groups,
                   highlight_diagonals = list("born 1950 - 1959" = 8,
                                              "born 1970 - 1979" = 10),
                   log_scale           = TRUE)

plot_densityMatrix(dat              = travel,
                   y_var            = "mainTrip_distance",
                   age_groups       = age_groups,
                   period_groups    = period_groups,
                   log_scale        = TRUE,
                   y_var_cat_breaks = dist_cat_breaks,
                   y_var_cat_labels = dist_cat_labels,
                   highlight_diagonals = list("born 1950 - 1959" = 8,
                                              "born 1970 - 1979" = 10),
                   legend_title     = "Distance category")

plot_densityMatrix(dat              = travel,
                   y_var            = "mainTrip_distance",
                   dimensions       = c("period","cohort"),
                   period_groups    = period_groups,
                   cohort_groups    = cohort_groups,
                   log_scale        = TRUE,
                   y_var_cat_breaks = dist_cat_breaks,
                   y_var_cat_labels = dist_cat_labels,
                   legend_title     = "Distance category")
```


```{r density matrix boxplot, warning = FALSE}
plot_densityMatrix(dat           = travel,
                   y_var         = "mainTrip_distance",
                   plot_type     = "boxplot",
                   age_groups    = age_groups,
                   period_groups = period_groups,
                   log_scale     = TRUE,
                   highlight_diagonals = list("born 1950 - 1959" = 8,
                                              "born 1970 - 1979" = 10))
```


```{r density matrix categorical}
plot_densityMatrix(dat                 = travel,
                   y_var               = "household_size",
                   age_groups          = age_groups,
                   period_groups       = period_groups,
                   highlight_diagonals = list("born 1950 - 1959" = 8,
                                              "born 1970 - 1979" = 10))
```


# Model-based analyses

### Wrapper function for the estimation of mgcv::gam

```{r}
model_pure <- gam(mainTrip_distance ~ te(age, period, bs = "ps", k = c(8,8)),
                  data = travel)
model_cov  <- gam(mainTrip_distance ~ te(age, period, bs = "ps", k = c(8,8)) +
                    residence_region + household_size + s(household_income),
                  data = travel)
```

### Partial effect plots

```{r}
plot_partialAPCeffects(model_pure, dat = travel, variable = "period")
plot_marginalAPCeffects(model_pure, dat = travel, variable = "cohort",
                        vlines_vec = c(1939,1955, 1980))

model_list <- list("pure model"      = model_pure,
                   "covariate model" = model_cov)
plot_jointMarginalAPCeffects(model_list, dat = travel,
                             vlines_list = list("cohort" = c(1939,1955, 1980)))
```

### Non-smoothed heatmaps

```{r}
# observed heatmap
plot_APCheatmap(dat = travel, y_var = "mainTrip_distance", bin_heatmap = FALSE,
                y_var_logScale = TRUE)

# with binning
plot_APCheatmap(dat = travel, y_var = "mainTrip_distance", bin_heatmap = TRUE,
                y_var_logScale = TRUE)

# flexibly choose which A, P, C dimension should be plotted on which axis
plot_APCheatmap(dat = travel, y_var = "mainTrip_distance", dimensions = c("cohort","age"),
                y_var_logScale = TRUE)

# add some reference lines, with manual binning
manual_binning <- list(period = seq(min(travel$period, na.rm = TRUE) - 1, max(travel$period, na.rm = TRUE), by = 5),
                       age    = seq(min(travel$age, na.rm = TRUE) - 1, max(travel$age, na.rm = TRUE), by = 5),
                       cohort = c(1875,1910,1939,1955,1980,2005))
plot_APCheatmap(dat = travel, y_var = "mainTrip_distance", y_var_logScale = TRUE,
                bin_heatmapGrid_list = manual_binning,
                markLines_list = list(cohort = c(1910,1939,1955,1980)))

# cohort on the y-axis, without manual binning
plot_APCheatmap(dat = travel, y_var = "mainTrip_distance", y_var_logScale = TRUE,
                dimensions = c("period","cohort"),
                markLines_list = list(cohort = c(1910,1939,1955,1980)))
```

### Smoothed, model-based heatmaps

```{r}
# estimated heatmap
APCtools::plot_APCheatmap(dat = travel, model = model_pure, plot_CI = FALSE,
                          bin_heatmap = FALSE)

# binned heatmap
APCtools::plot_APCheatmap(dat = travel, model = model_pure, plot_CI = FALSE)

# including confidence intervals
APCtools::plot_APCheatmap(dat = travel, model = model_pure)

# flexibly choose which A, P, C dimension should be plotted on which axis
APCtools::plot_APCheatmap(dat = travel, model = model_pure,
                          dimensions = c("cohort","age"), plot_CI = FALSE)

# add some reference lines
APCtools::plot_APCheatmap(dat = travel, model = model_pure, plot_CI = FALSE, bin_heatmap = FALSE,
                          markLines_list = list(cohort = c(1910,1939,1955,1980)))
APCtools::plot_APCheatmap(dat = travel, model = model_pure, plot_CI = FALSE, bin_heatmap = FALSE,
                          markLines_list = list(age = c(25,35,70)), dimensions = c("period","cohort"))
APCtools::plot_APCheatmap(dat = travel, model = model_pure, plot_CI = T, bin_heatmap = FALSE,
                          markLines_list = list(age = c(25,35,70)), dimensions = c("period","cohort"))

# manual binning
manual_binning <- list(period = seq(min(travel$period, na.rm = TRUE) - 1, max(travel$period, na.rm = TRUE), by = 5),
                       cohort = seq(min(travel$period - travel$age, na.rm = TRUE) - 1, max(travel$period - travel$age, na.rm = TRUE), by = 10))
APCtools::plot_APCheatmap(dat = travel, model = model_pure, plot_CI = FALSE,
                          bin_heatmapGrid_list = manual_binning)
```

### Hexamaps

```{r}
data(drug_deaths)

plot_APChexamap(data = drug_deaths,
                first_age = 15,
                first_period = 1999,
                interval = 1, 
                first_age_isoline = 20,
                first_period_isoline = 2000,
                isoline_interval = 5, 
                color_scale = c(0,40), 
                wrap_cohort_labels = T)
```

### Overview table

```{r}
create_APCsummary(model_list, dat = travel)
```

### Effect plots of linear and nonlinear effects

```{r}
APCtools::plot_linearEffects(model_cov)
APCtools::plot_1Dsmooth(model_cov, select = 2)
```

### Overview tables of linear and nonlinear effects

```{r}
summary_list <- create_covariateSummary(model_list)
summary_list[[1]]
summary_list[[2]]
```
